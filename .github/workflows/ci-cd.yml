name: CI/CD Pipeline

on:
  push:
    branches:
      - main

jobs:
  # ====== CI STAGES ======
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

  dependencies:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: python -m pip install --upgrade pip

  linting:
    runs-on: ubuntu-latest
    needs: dependencies
    steps:
      - name: Lint code with flake8
        run: |
          pip install flake8
          flake8 .

  scanning:
    runs-on: ubuntu-latest
    needs: linting
    steps:
      - name: Bandit Security Scan
        run: |
          pip install bandit
          bandit -r .
      - name: Trivy File System Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          ignore-unfixed: true
          severity: CRITICAL,HIGH
          exit-code: 0

  build:
    runs-on: ubuntu-latest
    needs: scanning
    steps:
      - name: Build Docker image
        run: docker build -t 123pavan123/nginx-test:latest .

  push_artifacts:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Push Docker image to Docker Hub
        run: |
          echo "${{ secrets.DOCKER_HUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin
          docker push 123pavan123/nginx-test:latest

  # ====== CD STAGE ======
  deploy_gke:
    runs-on: ubuntu-latest
    needs: push_artifacts
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: gke-demo-1761650657
          export_default_credentials: true

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials gke-demo-cluster \
            --zone us-central1-a --project gke-demo-1761650657
          exit 0

      - name: Deploy to GKE
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/nginx-deployment || echo "⚠️ Rollout check failed, continuing."


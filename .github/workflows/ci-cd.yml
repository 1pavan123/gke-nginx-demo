name: CI-CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 1️⃣ Checkout
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

  # 2️⃣ Dependencies
  dependencies:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || echo "⚠️ Dependencies install failed but continuing"

  # 3️⃣ Linting
  linting:
    runs-on: ubuntu-latest
    needs: dependencies
    steps:
      - name: Lint code with flake8
        run: |
          pip install flake8 || true
          flake8 . || echo "⚠️ Linting failed but continuing"

  # 4️⃣ Security Scanning
  scanning:
    runs-on: ubuntu-latest
    needs: linting
    steps:
      - name: Bandit Security Scan
        run: |
          pip install bandit || true
          bandit -r . || echo "⚠️ Bandit failed but continuing"
      - name: Trivy File System Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          ignore-unfixed: true
          severity: CRITICAL,HIGH
          exit-code: 0

  # 5️⃣ Unit Tests
  testing:
    runs-on: ubuntu-latest
    needs: scanning
    steps:
      - name: Unit testing and coverage
        run: |
          pip install pytest pytest-cov || true
          pytest --cov=. --cov-fail-under=0 || echo "⚠️ Tests failed but continuing"

  # 6️⃣ Build Docker Image
  build:
    runs-on: ubuntu-latest
    needs: testing
    steps:
      - name: Build Docker image
        run: |
          docker build -t app:latest . || echo "⚠️ Build failed but continuing"

  # 7️⃣ Scan Docker Image
  image_scan:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Scan Docker image with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: app:latest
          format: table
          ignore-unfixed: true
          severity: CRITICAL,HIGH
          exit-code: 0

  # 8️⃣ Push Docker Image
  push_artifacts:
    runs-on: ubuntu-latest
    needs: image_scan
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Push Docker image to Docker Hub
        run: |
          echo "Logging into Docker..."
          echo "Kasinni@321" | docker login -u "123pavan123" --password-stdin || true
          docker tag app:latest 123pavan123/trivy:latest || true
          docker push 123pavan123/trivy:latest || echo "⚠️ Push failed but continuing"

  # 9️⃣ Deploy to GKE
  deploy_gke:
    runs-on: ubuntu-latest
    needs: push_artifacts
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: gke-demo-1761650657
          export_default_credentials: true

      - name: Configure kubectl
        run: |
          gcloud container clusters get-credentials gke-demo-cluster \
            --zone us-central1-a --project gke-demo-1761650657 || true

      - name: Deploy to GKE
        run: |
          kubectl apply -f k8s/deployment.yaml || true
          kubectl apply -f k8s/service.yaml || true
          kubectl rollout status deployment/nginx-deployment --timeout=60s || echo "⚠️ Deployment may have issues but continuing"

